<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="mb-0">Ficha de: <%= @trabajador.nombre %></h1>
  <%= link_to 'Volver al listado', admin_trabajadores_path, class: 'btn btn-secondary' %>
</div>

<%# --- SECCIÓN 1: DATOS PRINCIPALES Y ACCIONES --- %>
<div class="card mb-4">
  <div class="card-header">
    <h5 class="mb-0">Datos Principales</h5>
  </div>
  <div class="card-body">
    <dl class="row">
      <dt class="col-sm-3">Tipo de Contrato Actual</dt>
      <dd class="col-sm-9">
        <%= @trabajador.tipo_contrato&.nombre || 'N/A' %>
      </dd>
      <dt class="col-sm-3">Jornada Semanal Actual</dt>
      <dd class="col-sm-9">
        <%= number_to_human(@trabajador.jornada_semanal_actual,
          precision: 2, strip_insignificant_zeros: true) %> h
      </dd>
    </dl>
    <hr>
    <div class="d-flex justify-content-between">
      <%= link_to 'Editar Datos', edit_admin_trabajador_path(@trabajador), class: 'btn btn-primary' %>

      <!-- Botón para abrir el modal de eliminación -->
      <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
        Eliminar Ficha
      </button>
    </div>
  </div>
</div>

<!-- Modal de Confirmación de Eliminación -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel">Confirmar Eliminación</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <%= form_with(url: admin_trabajador_path(@trabajador), method: :delete) do |form| %>
        <div class="modal-body">
          <p>¿Estás seguro de que quieres eliminar a <strong><%= @trabajador.nombre %></strong>? Esta acción no se puede deshacer y eliminará todos sus datos asociados (contratos, horarios, bolsa de horas, etc.).</p>
          <div class="mb-3">
            <%= form.label :current_password, "Por seguridad, introduce tu contraseña:", class: "form-label" %>
            <%= form.password_field :current_password, class: "form-control", required: true %>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <%= form.submit "Eliminar Definitivamente", class: "btn btn-danger" %>
        </div>
      <% end %>
    </div>
  </div>
</div>


<%# --- SECCIÓN 2: HISTORIAL DE CONTRATOS Y JORNADAS --- %>
<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">Historial de Jornadas</h5>
    <%= link_to "Añadir Nueva Jornada", new_admin_trabajador_historial_contrato_path(@trabajador), class: "btn btn-primary" %>
  </div>
  <div class="card-body">
    <p><strong>Jornada Semanal Actual:</strong> <%= number_with_precision(@trabajador.jornada_semanal_actual, precision: 2) || 'N/A' %> horas</p>

    <% if @historial_contratos.any? %>
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Horas Semanales</th>
            <th>Fecha de Inicio</th>
            <th>Fecha de Fin</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>
          <% @historial_contratos.each do |contrato| %>
            <tr>
              <td><%= number_with_precision(contrato.horas_semanales_contratadas, precision: 2) %></td>
              <td><%= l contrato.fecha_inicio_vigencia, format: :long %></td>
              <td><%= contrato.fecha_fin_vigencia ? (l contrato.fecha_fin_vigencia, format: :long) : '' %></td>
              <td>
                <% unless contrato.fecha_fin_vigencia %>
                  <span class="badge bg-success">Vigente</span>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <p class="text-muted">No hay historial de jornadas para este trabajador.</p>
    <% end %>
  </div>
</div>

<%# --- SECCIÓN 3: CALENDARIO LABORAL (HORARIOS TEÓRICOS) --- %>
<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">Calendario Laboral (Horarios Teóricos)</h5>
    <%= link_to "Asignar/Cambiar Horario", new_admin_trabajador_asignacion_turno_path(@trabajador), class: "btn btn-primary" %>
  </div>
  <div class="card-body">
    <%# Buscamos la asignación vigente (la que no tiene fecha de fin) %>
    <% asignacion_vigente = @asignaciones_turno.find { |a| a.fecha_fin.nil? } %>
    <% if asignacion_vigente %>
      <h6>Horario Vigente (<%= asignacion_vigente.plantilla_horario.nombre %>)</h6>
      <%= render 'parrilla_horario', horario: asignacion_vigente.plantilla_horario.horario %>
      <hr>
    <% end %>

    <h6>Historial de Asignaciones de Horario</h6>
    <% if @asignaciones_turno.any? %>
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Plantilla de Horario</th>
            <th>Fecha de Inicio</th>
            <th>Fecha de Fin</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>
          <% @asignaciones_turno.each do |asignacion| %>
            <tr>
              <td><%= asignacion.plantilla_horario.nombre %></td>
              <td><%= l asignacion.fecha_inicio, format: :long %></td>
              <td><%= asignacion.fecha_fin ? (l asignacion.fecha_fin, format: :long) : '' %></td>
              <td>
                <% unless asignacion.fecha_fin %>
                  <span class="badge bg-success">Vigente</span>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <p class="text-muted">No se han asignado horarios a este trabajador.</p>
    <% end %>
  </div>
</div>

<%# --- SECCIÓN 4: RESUMEN Y GESTIÓN DE LA BOLSA DE HORAS --- %>
<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">Resumen y Gestión de la Bolsa de Horas</h5>
    <%= link_to "Añadir Ajuste Manual", new_admin_trabajador_movimiento_bolsa_path(@trabajador), class: "btn btn-primary" %>
  </div>
  <div class="card-body">
    <h6>Saldos Actuales</h6>
    <dl class="row">
      <dt class="col-sm-3">Saldo Bolsa de Horas</dt>
      <dd class="col-sm-9"><%= number_with_precision(@trabajador.bolsa_horas_saldo&.horas, precision: 2, default: '0.00') %> h</dd>

      <dt class="col-sm-3">Saldo Bolsa de Festivos</dt>
      <dd class="col-sm-9"><%= number_with_precision(@trabajador.bolsa_horas_saldo&.festivos, precision: 2, default: '0.00') %> h</dd>

      <dt class="col-sm-3">Saldo Bolsa de Libranza</dt>
      <dd class="col-sm-9"><%= number_with_precision(@trabajador.bolsa_horas_saldo&.libranza, precision: 2, default: '0.00') %> h</dd>
    </dl>
    <hr>

    <h6>Historial de Movimientos de Bolsa</h6>
    <% if @movimientos_bolsa.any? %>
      <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
        <table class="table table-striped table-sm">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Tipo</th>
              <th>Bolsa</th>
              <th class="text-end">Cantidad</th>
              <th>Concepto</th>
            </tr>
          </thead>
          <tbody>
            <% @movimientos_bolsa.each do |movimiento| %>
              <tr>
                <td><%= l movimiento.fecha_efectiva, format: :default %></td>
                <td><%= movimiento.tipo_movimiento.humanize %></td>
                <td><%= movimiento.categoria_bolsa_afectada.humanize %></td>
                <td class="text-end fw-bold <%= movimiento.cantidad_horas >= 0 ? 'text-success' : 'text-danger' %>"><%= sprintf('%+.2f', movimiento.cantidad_horas) %></td>
                <td><%= movimiento.concepto %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <p class="text-muted">No hay movimientos en la bolsa de horas para este trabajador.</p>
    <% end %>
  </div>
</div>

<%# --- SECCIÓN 5: HISTORIAL DE JORNADA ANUAL --- %>
<div class="card mb-4">
  <div class="card-header">
    <h5 class="mb-0">Historial de Jornada Anual</h5>
  </div>
  <div class="card-body">
    <table class="table table-striped table-hover mb-0">
      <thead>
        <tr>
          <th>Año</th>
          <th class="text-end">Horas Teóricas</th>
          <th class="text-end">Horas Reales</th>
          <th class="text-end">Balance</th>
        </tr>
      </thead>
      <tbody>
        <% @historial_jornada_anual_registros.each do |registro| %>
          <tr>

          <td><strong><%= registro.anio %></strong></td>
            <td class="text-end"><%= number_with_precision(registro.horas_teoricas, precision: 2) %>h</td>
            <td class="text-end"><%= number_with_precision(registro.horas_reales, precision: 2) %>h</td>
            <td class="text-end">
              <strong class="<%= registro.balance.negative? ? 'text-danger' : 'text-success' %>"><%= sprintf('%+.2f', registro.balance) %>h</strong>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>