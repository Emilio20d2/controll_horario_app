<% content_for :title, "Ficha de #{@trabajador.nombre}" %>

<div class="page-header">
  <h1>Ficha de Empleado</h1>
  <%= link_to '« Volver al Listado', admin_trabajadores_path, class: 'btn btn-secondary' %>
</div>

<div class="card">
  <div class="card-body">
    <%# --- SECCIÓN 1: DATOS PRINCIPALES Y ACCIONES --- %>
    <div class="d-flex justify-content-between align-items-start mb-4">
      <div>
        <h2 class="card-title"><%= @trabajador.nombre %></h2>
        <p class="card-text text-muted">
          <strong>Contrato Actual:</strong> <%= @trabajador.tipo_contrato.nombre %><br>
          <strong>Jornada Semanal Actual:</strong> <%= number_with_precision(@trabajador.jornada_semanal_actual, precision: 2) %> horas
        </p>
      </div>
      <div class="btn-group">
        <%= link_to 'Editar Datos', edit_admin_trabajador_path(@trabajador), class: 'btn btn-primary' %>
        <%= button_to 'Eliminar Ficha', admin_trabajador_path(@trabajador), method: :delete, class: 'btn btn-danger', form: { data: { turbo_confirm: "ATENCIÓN: ¿Estás seguro de que quieres eliminar a '#{@trabajador.nombre}'? Esta acción no se puede deshacer y se requerirá tu contraseña." } } %>
      </div>
    </div>
    <hr>

    <%# --- SECCIÓN 2: HISTORIAL DE CONTRATOS Y JORNADAS --- %>
    <h4 class="mt-4">Historial de Jornadas</h4>
    <% if @historial_contratos.any? %>
      <table class="table table-striped table-sm">
        <thead>
          <tr>
            <th>Horas Semanales</th>
            <th>Fecha Inicio Vigencia</th>
            <th>Fecha Fin Vigencia</th>
          </tr>
        </thead>
        <tbody>
          <% @historial_contratos.each do |contrato| %>
            <tr>
              <td><%= number_with_precision(contrato.horas_semanales_contratadas, precision: 2) %></td>
              <td><%= l contrato.fecha_inicio_vigencia, format: :short %></td>
              <td><%= contrato.fecha_fin_vigencia ? (l contrato.fecha_fin_vigencia, format: :short) : 'Actual' %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <p>No hay historial de jornadas para este trabajador.</p>
    <% end %>
    <%= link_to 'Añadir Nueva Jornada', '#', class: 'btn btn-sm btn-outline-primary' %>
    <hr>

    <%# --- SECCIÓN 3: CALENDARIO LABORAL (HORARIOS TEÓRICOS) --- %>
    <h4 class="mt-4">Calendario Laboral</h4>
    <p><em>(Visualización de la parrilla 4x7 del horario actual irá aquí)</em></p>
    <%= link_to 'Asignar/Cambiar Horario', '#', class: 'btn btn-sm btn-outline-primary' %>
    <hr>

    <%# --- SECCIÓN 4: RESUMEN Y GESTIÓN DE LA BOLSA DE HORAS --- %>
    <h4 class="mt-4">Resumen de Bolsas de Horas</h4>
    <% if @trabajador.bolsa_horas_saldo %>
      <ul class="list-group list-group-flush">
        <li class="list-group-item d-flex justify-content-between align-items-center">
          Bolsa de Horas
          <span class="badge bg-primary rounded-pill"><%= number_with_precision(@trabajador.bolsa_horas_saldo.horas_trabajadas_acumuladas, precision: 2) %> h</span>
        </li>
        <li class="list-group-item d-flex justify-content-between align-items-center">
          Bolsa de Festivos
          <span class="badge bg-primary rounded-pill"><%= number_with_precision(@trabajador.bolsa_horas_saldo.horas_festivo_trabajado, precision: 2) %> h</span>
        </li>
        <li class="list-group-item d-flex justify-content-between align-items-center">
          Bolsa de Libranza
          <span class="badge bg-primary rounded-pill"><%= number_with_precision(@trabajador.bolsa_horas_saldo.horas_festivo_libranza, precision: 2) %> h</span>
        </li>
      </ul>
    <% else %>
      <p>No hay saldos de bolsa registrados para este trabajador.</p>
    <% end %>
    <div class="mt-3">
      <%= link_to 'Añadir Ajuste Manual', '#', class: 'btn btn-sm btn-outline-secondary' %>
    </div>
    <hr>

    <%# --- SECCIÓN 5: CÓMPUTO DE JORNADA ANUAL --- %>
    <h4 class="mt-4">Cómputo de Jornada Anual (<%= @anio_actual %>)</h4>
    <p><em>(Cálculo de la jornada anual para <%= @anio_actual %> irá aquí)</em></p>
    
    <h5 class="mt-3">Historial de Balances Anuales</h5>
    <% if @historial_jornada_anual_registros.any? %>
      <table class="table table-striped table-sm">
        <thead>
          <tr>
            <th>Año</th>  
            <th>Jornada Ajustada</th>
            <th>Horas Realizadas</th>
            <th>Balance Final</th>
          </tr>
        </thead>
        <tbody>
          <% @historial_jornada_anual_registros.each do |registro| %>
            <tr>
              <td><%= registro.anio %></td>
              <td><%= number_with_precision(registro.jornada_anual_ajustada, precision: 2) %></td>
              <td><%= number_with_precision(registro.horas_anuales_realizadas, precision: 2) %></td>
              <td><%= number_with_precision(registro.balance_final, precision: 2) %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <p>No hay balances anuales registrados.</p>
    <% end %>
  </div>
</div>
