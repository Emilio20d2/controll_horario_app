<%#
  Vista de detalle para un trabajador. Muestra toda la información relevante
  y proporciona acciones específicas para ese trabajador.
%>

<div class="page-header">
  <h1>Ficha de: <%= @trabajador.nombre %></h1>
  <div>
    <%= link_to 'Editar Ficha', edit_admin_trabajador_path(@trabajador), class: 'btn btn-secondary' %>
    <%= link_to 'Asignar Horario', new_admin_trabajador_asignacion_turno_path(@trabajador), class: 'btn btn-info' %>
    <%= link_to 'Ajuste Manual Bolsa', new_admin_trabajador_movimiento_bolsa_path(@trabajador), class: 'btn btn-warning' %>
    <%= link_to 'Volver al Listado', admin_trabajadores_path, class: 'btn btn-outline-secondary ms-2' %>
  </div>
</div>

<div class="row mt-4">
  <%# Columna izquierda: Datos del trabajador %>
  <div class="col-md-5">
    <div class="card">
      <div class="card-header">
        <h5>Datos del Trabajador</h5>
      </div>
      <ul class="list-group list-group-flush">
        <li class="list-group-item"><strong>Tipo Contrato:</strong> <%= @trabajador.tipo_contrato&.nombre || 'N/A' %></li>
        <li class="list-group-item"><strong>Jornada Semanal:</strong> <%= number_to_human(@trabajador.jornada_semanal_actual, precision: 2, strip_insignificant_zeros: true) %> horas</li>
      </ul>
    </div>
  </div>

  <%# Columna derecha: Calendario laboral vigente %>
  <div class="col-md-7">
    <div class="card">
      <div class="card-header">
        <h5>Calendario Laboral Vigente</h5>
      </div>
      <div class="card-body p-0">
        <% asignacion_vigente = @asignaciones_turno.first %>
        <% if asignacion_vigente && asignacion_vigente.plantilla_horario&.horario %>
          <div class="table-responsive">
            <table class="table table-bordered table-sm text-center mb-0">
              <thead class="table-light">
                <tr>
                  <th>Turno</th>
                  <th>L</th><th>M</th><th>X</th><th>J</th><th>V</th><th>S</th><th>D</th>
                </tr>
              </thead>
              <tbody>
                <% (1..4).each do |turno_num| %>
                  <tr>
                    <td><strong>T<%= turno_num %></strong></td>
                    <% %w[lunes martes miercoles jueves viernes sabado domingo].each do |dia| %>
                      <td><%= asignacion_vigente.plantilla_horario.horario.dig("turno#{turno_num}", dia) || 0 %></td>
                    <% end %>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <div class="alert alert-warning m-3">No hay un horario asignado para este trabajador.</div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<div class="card mt-4">
  <div class="card-header">
    <h5>Balance de Jornada Anual</h5>
  </div>
  <div class="card-body">
    <%# Sección para el cálculo del año actual %>
    <div class="mb-4 p-3 bg-light rounded">
      <h6>Balance para el año en curso (<%= @anio_actual %>)</h6>
      <% if @calculo_jornada_actual && !@calculo_jornada_actual[:error] %>
        <div class="row">
          <div class="col"><strong>Teóricas:</strong> <%= number_with_precision(@calculo_jornada_actual[:horas_teoricas], precision: 2) %> h</div>
          <div class="col"><strong>Reales:</strong> <%= number_with_precision(@calculo_jornada_actual[:horas_reales], precision: 2) %> h</div>
          <div class="col">
            <strong>Balance:</strong>
            <% balance = @calculo_jornada_actual[:balance] %>
            <span class="<%= balance >= 0 ? 'text-success' : 'text-danger' %> fw-bold">
              <%= number_with_precision(balance, precision: 2) %> h
            </span>
          </div>
        </div>
      <% else %>
        <div class="alert alert-info mb-0"><%= @calculo_jornada_actual[:error] || "No se pudo calcular el balance para el año actual." %></div>
      <% end %>
    </div>

    <%# Sección para el historial de balances guardados %>
    <h6>Historial de Balances Guardados</h6>
    <% if @historial_jornada_anual_registros.any? %>
      <table class="table table-sm table-striped">
        <thead>
          <tr>
            <th>Año</th><th>Jornada Ajustada</th><th>Horas Realizadas</th><th>Balance Final</th>
          </tr>
        </thead>
        <tbody>
          <% @historial_jornada_anual_registros.each do |registro| %>
            <tr>
              <td><%= registro.anio %></td>
              <td><%= number_with_precision(registro.jornada_anual_ajustada / 60.0, precision: 2) %> h</td>
              <td><%= number_with_precision(registro.horas_anuales_realizadas / 60.0, precision: 2) %> h</td>
              <td>
                <% balance = registro.balance_final / 60.0 %>
                <span class="<%= balance >= 0 ? 'text-success' : 'text-danger' %> fw-bold"><%= number_with_precision(balance, precision: 2) %> h</span>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <p>No hay balances anuales guardados para este trabajador.</p>
    <% end %>

    <%# Formulario para guardar el balance de un año específico %>
    <hr>
    <h6>Guardar Balance Anual</h6>
    <%= form_with(url: admin_trabajador_historial_jornada_anuales_path(@trabajador), method: :post, class: "row g-3 align-items-center") do |form| %>
      <div class="col-auto">
        <%= form.label :anio, "Año a calcular y guardar:", class: "col-form-label" %>
      </div>
      <div class="col-auto">
        <%= form.number_field :anio, class: "form-control", value: Date.today.year - 1, required: true %>
      </div>
      <div class="col-auto">
        <%= form.submit "Guardar Balance", class: "btn btn-success" %>
      </div>
    <% end %>
  </div>
</div>