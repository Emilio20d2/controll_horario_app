<%#
  Vista de detalle para un trabajador. Muestra toda la información relevante
  y proporciona acciones específicas para ese trabajador.
%>

<div class="page-header">
  <h1>Ficha de: <%= @trabajador.nombre %></h1>
  <div>
    <%= link_to 'Editar Ficha', edit_admin_trabajador_path(@trabajador), class: 'btn btn-secondary' %>
    <%= link_to 'Asignar Horario', new_admin_trabajador_asignacion_turno_path(@trabajador), class: 'btn btn-info' %>
    <%= link_to 'Ajuste Manual Bolsa', new_admin_trabajador_movimiento_bolsa_path(@trabajador), class: 'btn btn-warning' %>
    <%= link_to 'Volver al Listado', admin_trabajadores_path, class: 'btn btn-outline-secondary ms-2' %>
  </div>
</div>

<div class="row mt-4">
  <%# Columna izquierda: Datos del trabajador %>
  <div class="col-md-5">
    <div class="card">
      <div class="card-header">
        <h5>Datos del Trabajador</h5>
      </div>
      <ul class="list-group list-group-flush">
        <li class="list-group-item"><strong>Tipo Contrato:</strong> <%= @trabajador.tipo_contrato&.nombre || 'N/A' %></li>
        <li class="list-group-item"><strong>Jornada Semanal:</strong> <%= number_to_human(@trabajador.jornada_semanal_actual, precision: 2, strip_insignificant_zeros: true) %> horas</li>
      </ul>
    </div>
  </div>

  <%# Columna derecha: Calendario laboral vigente %>
  <div class="col-md-7">
    <div class="card">
      <div class="card-header">
        <h5>Calendario Laboral Vigente</h5>
      </div>
      <div class="card-body p-0">
        <% asignacion_vigente = @asignaciones_turno.first %>
        <% if asignacion_vigente && asignacion_vigente.plantilla_horario&.horario %>
          <div class="table-responsive">
            <table class="table table-bordered table-sm text-center mb-0">
              <thead class="table-light">
                <tr>
                  <th>Turno</th>
                  <th>L</th><th>M</th><th>X</th><th>J</th><th>V</th><th>S</th><th>D</th>
                </tr>
              </thead>
              <tbody>
                <% (1..4).each do |turno_num| %>
                  <tr>
                    <td><strong>T<%= turno_num %></strong></td>
                    <% %w[lunes martes miercoles jueves viernes sabado domingo].each do |dia| %>
                      <td><%= asignacion_vigente.plantilla_horario.horario.dig("turno#{turno_num}", dia) || 0 %></td>
                    <% end %>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <div class="alert alert-warning m-3">No hay un horario asignado para este trabajador.</div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<div class="card mt-4">
  <div class="card-header">
    <h5>Balance de Jornada Anual</h5>
  </div>
  <div class="card-body">
    <%# Sección para el cálculo del año actual %>
    <div class="mb-4 p-3 bg-light rounded">
      <h6>Balance para el año en curso (<%= @anio_actual %>)</h6>
      <% if @calculo_jornada_actual && !@calculo_jornada_actual[:error] %>
        <div class="row">
          <div class="col"><strong>Teóricas:</strong> <%= number_with_precision(@calculo_jornada_actual[:horas_teoricas], precision: 2) %> h</div>
          <div class="col"><strong>Reales:</strong> <%= number_with_precision(@calculo_jornada_actual[:horas_reales], precision: 2) %> h</div>
          <div class="col">
            <strong>Balance:</strong>
            <% balance = @calculo_jornada_actual[:balance] %>
            <span class="<%= balance >= 0 ? 'text-success' : 'text-danger' %> fw-bold">
              <%= number_with_precision(balance, precision: 2) %> h
            </span>
          </div>
        </div>
      <% else %>
        <div class="alert alert-info mb-0"><%= @calculo_jornada_actual[:error] || "No se pudo calcular el balance para el año actual." %></div>
      <% end %>
    </div>

    <%# Tabla histórica de jornada anual %>
    <h6>Histórico anual</h6>
    <table class="table table-sm table-striped">
      <thead>
        <tr>
          <th>Año</th>
          <th>Jornada anual teórica</th>
          <th>Horas trabajadas reales</th>
          <th>Diferencia (haber/deber)</th>
        </tr>
      </thead>
      <tbody>
        <% @resumen_jornadas.each do |r| %>
          <tr>
            <td><%= r[:anio] %></td>
            <td><%= number_with_precision(r[:jornada_anual_ajustada], precision: 2) %> h</td>
            <td><%= number_with_precision(r[:horas_anuales_realizadas], precision: 2) %> h</td>
            <td>
              <span class="<%= r[:balance_final] >= 0 ? 'text-success' : 'text-danger' %> fw-bold">
                <%= number_with_precision(r[:balance_final], precision: 2) %> h
              </span>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>