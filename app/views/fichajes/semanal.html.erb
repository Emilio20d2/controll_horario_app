<%# app/views/fichajes/semanal.html.erb %>
<% content_for :title, "Confirmación Semanal" %>

<div class="container content-box"
     data-controller="semanal"
     data-semanal-year-value="<%= @anio_seleccionado %>"
     data-semanal-week-num-value="<%= @semana_seleccionada %>">

  <div class="sticky-week-header d-flex justify-content-between align-items-center">
    <div>
      <%= link_to '← Semana anterior', fichajes_semanal_path(@params_semana_anterior), class: 'btn btn-outline-primary btn-sm me-2' %>
      <strong>Del <%= l(@fecha_lunes, format: :short) %> al <%= l(@fecha_lunes + 6.days, format: :short) %></strong>
      <%= link_to 'Semana siguiente →', fichajes_semanal_path(@params_semana_siguiente), class: 'btn btn-outline-primary btn-sm ms-2' %>
    </div>
    <%= link_to 'Volver al menú principal', root_path, class: 'btn btn-secondary btn-sm' %>
  </div>

  <% @trabajadores.each do |trabajador| %>
    <%= form_with(url: procesar_fila_trabajador_path, method: :post,
                  class: 'mini-table-container',
                  data: {
                    controller: 'previsualizacion',
                    action: 'change->previsualizacion#recalcular',
                    previsualizacion_jornada_semanal_value: trabajador.jornada_semanal_actual,
                    previsualizacion_dias_laborables_value: trabajador.contrato_vigente_en(@fecha_lunes)&.dias_laborables_semana_contratados || 5,
                    previsualizacion_acumula_festivos_value: trabajador.tipo_contrato.acumula_festivo_trabajado_en_bolsa,
                    previsualizacion_acumula_libranza_value: trabajador.tipo_contrato.acumula_festivo_en_libranza
                  }) do |form| %>
      <table class="schedule-table table-bordered mb-0">
        <thead>
          <tr>
            <th>Empleado</th>
            <% @fechas_semana.each do |fecha| %>
              <th class="text-center">
                <%= l(fecha, format: '%A') %><br>
                <small><%= l(fecha, format: '%d/%m') %></small>
              </th>
            <% end %>
          </tr>
        </thead>
        <tbody>
          <tr class="trabajador-row" id="fila_trabajador_<%= trabajador.id %>">
            <td class="empleado-cell">
              <strong><%= trabajador.nombre %></strong><br>
              <small>Jornada: <%= number_with_precision(trabajador.jornada_semanal_actual, precision: 0) %>h/semana</small><br>
              <small><%= trabajador.tipo_contrato.nombre %></small>
              <%= form.hidden_field :trabajador_id, value: trabajador.id %>
              <%= form.hidden_field :anio, value: @anio_seleccionado %>
              <%= form.hidden_field :semana, value: @semana_seleccionada %>
            </td>
            <% @fechas_semana.each do |fecha| %>
              <td class="day-cell">
                <%= render 'celda_dia', trabajador: trabajador, fecha: fecha, form: form %>
              </td>
            <% end %>
          </tr>
        </tbody>
        <tfoot>
          <tr>
            <td colspan="<%= @fechas_semana.size + 1 %>">
              <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex gap-3">
                  <span>Total: <strong data-previsualizacion-target="totalComputadas">0h</strong></span>
                  <span>B.Horas: <strong data-previsualizacion-target="impactoOrdinaria">0h</strong></span>
                  <span>B.Festivo: <strong data-previsualizacion-target="impactoFestivos">0h</strong></span>
                  <span>B.Libranza: <strong data-previsualizacion-target="impactoLibranza">0h</strong></span>
                </div>
                <% procesado = @semanas_procesadas.include?(trabajador.id) %>
                <% texto_boton = procesado ? 'Confirmado ✓' : 'Confirmar semana' %>
                <% clase_boton = procesado ? 'btn btn-success btn-sm' : 'btn btn-primary btn-sm' %>
                <%= form.button texto_boton, class: clase_boton %>
              </div>
            </td>
          </tr>
        </tfoot>
      </table>
    <% end %>
  <% end %>
</div>
