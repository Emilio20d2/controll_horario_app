<%# app/views/fichajes/semanal.html.erb %>
<% content_for :title, "Confirmación Semanal" %>

<style>
  /* ... (Estilos CSS como en el mensaje #130) ... */
</style>

<div class="container content-box">
  <div class="page-header">
    <h1>Confirmación Semanal</h1>
    <%= link_to "« Volver al Menú", root_path, class: "btn btn-secondary" %>
  </div>

  <div class="week-selector d-flex justify-content-between align-items-center mb-3">
    <%= link_to "◄ Semana Anterior", fichajes_semanal_path(anio: @anio_seleccionado, semana: @semana_seleccionada - 1), class: "btn btn-secondary btn-sm" %>
    <h2 class="h5 m-0">Semana del <%= l(@fecha_lunes) %> al <%= l(@fecha_lunes + 6.days) %></h2>
    <%= link_to "Semana Siguiente ►", fichajes_semanal_path(anio: @anio_seleccionado, semana: @semana_seleccionada + 1), class: "btn btn-secondary btn-sm" %>
    <%= form_with url: fichajes_semanal_path, method: :get, class: "ms-3" do |f| %>
      <%= f.date_field :fecha, value: @fecha_lunes, class: "form-control form-control-sm", data: { action: "change->this.form.submit" } %>
    <% end %>
  </div>

  <form> <%# El form es solo un contenedor, el guardado se hará por fila %>
    <table class="schedule-table">
      <thead>
        <tr>
          <th>Empleado / Previsualización</th>
          <% @fechas_semana.each do |fecha| %>
            <th class="text-center">
              <%= l(fecha, format: '%A') %><br>
              <small><%= l(fecha, format: '%d/%m') %></small>
            </th>
          <% end %>
          <th class="acciones-col">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <% @trabajadores.each do |trabajador| %>
          <%# La fila <tr> es el controlador de Stimulus y contiene todas las reglas y datos %>
          <tr class="trabajador-row" 
              id="fila_trabajador_<%= trabajador.id %>" 
              data-controller="previsualizacion"
              data-previsualizacion-jornada-semanal-value="<%= trabajador.jornada_semanal_actual %>"
              data-previsualizacion-acumula-festivos-value="<%= trabajador.tipo_contrato.acumula_festivo_trabajado_en_bolsa %>"
              data-previsualizacion-acumula-libranza-value="<%= trabajador.tipo_contrato.acumula_festivo_en_libranza %>">
            <td class="empleado-cell">
              <strong><%= trabajador.nombre %></strong>
              <div class="preview-cell">
                <hr>
                <ul>
                  <li><span>Total Computado:</span> <strong data-previsualizacion-target="totalComputadas">...</strong></li>
                  <li><span>Impacto Bolsa Horas:</span> <strong data-previsualizacion-target="impactoOrdinaria">...</strong></li>
                  <li><span>Impacto Bolsa Festivos:</span> <strong data-previsualizacion-target="impactoFestivos">...</strong></li>
                  <li><span>Impacto Bolsa Libranza:</span> <strong data-previsualizacion-target="impactoLibranza">...</strong></li>
                </ul>
              </div>
            </td>
            
            <% @fechas_semana.each do |fecha| %>
              <% horas_teo = @horas_teoricas_map.dig(trabajador.id, fecha) || 0 %>
              <% entrada_dia = @entradas_diarias_map.dig(trabajador.id, fecha) %>
              <% festivo_obj = @festivos_semana_map[fecha] %>
              <% es_festivo = festivo_obj.present? %>
              <% es_apertura = es_festivo && festivo_obj.apertura_autorizada %>
              
              <td class="day-cell <%= 'festivo' if es_festivo %>" 
                  data-teoricas="<%= horas_teo %>" 
                  data-festivo="<%= es_festivo %>"
                  data-apertura-autorizada="<%= es_apertura %>">
                
                <div class="mb-2">
                  <label>H.Trab:</label>
                  <input type="number" name="dias[<%= fecha %>][horas_trabajadas]" value="<%= entrada_dia&.horas_trabajadas %>" placeholder="<%= '%.2f' % horas_teo %>" class="form-control form-control-sm" step="0.25" min="0" max="24" data-action="change->previsualizacion#recalcular">
                </div>
                <div class="mb-2" data-controller="cell">
                  <label>Ausencia:</label>
                  <%= select_tag "dias[#{fecha}][tipo_ausencia_id]",
                      options_for_select(@tipos_ausencia, entrada_dia&.tipo_ausencia_id),
                      include_blank: '---',
                      class: "form-select form-select-sm",
                      data: { action: "change->previsualizacion#recalcular blur->cell#showAbbreviations focus->cell#showFullNames",
                              cell_target: 'tipoAusenciaSelect' } %>
                  <div class="mt-1 d-none" data-cell-target="horasAusenciaWrapper">
                    <input type="number" name="dias[<%= fecha %>][horas_ausencia]" value="<%= entrada_dia&.horas_ausencia %>" class="form-control form-control-sm" step="0.25" data-action="change->previsualizacion#recalcular">
                  </div>
                </div>
                <% if es_apertura %>
                  <div class="form-check mb-2">
                    <input type="checkbox" name="dias[<%= fecha %>][pago_doble]" class="form-check-input" <%= 'checked' if entrada_dia&.pago_doble_marcado %> data-action="change->previsualizacion#recalcular">
                    <label class="form-check-label">P. Doble</label>
                  </div>
                <% end %>
                <div class="mb-2">
                  <label>H.Comp.P:</label>
                  <input type="number" name="dias[<%= fecha %>][horas_comp_pagadas]" value="<%= entrada_dia&.horas_comp_pagadas %>" class="form-control form-control-sm" step="0.25" data-action="change->previsualizacion#recalcular">
                </div>
                <div class="mb-2">
                  <textarea name="dias[<%= fecha %>][comentario]" class="form-control form-control-sm" placeholder="Notas/Motivos" data-action="change->previsualizacion#recalcular"><%= entrada_dia&.comentario %></textarea>
                </div>
              </td>
            <% end %>

            <td class="acciones-cell">
              <button type="submit" class="btn btn-primary btn-sm">Guardar</button>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </form>
  <div class="footer-nav">
       <%= link_to '« Volver al Menú', root_path, class: 'btn btn-secondary' %>
  </div>
</div>
